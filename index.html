
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 DS18B20 Realtime</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    body{margin:0;display:grid;min-height:100svh;place-items:center;background:#0f172a;color:#e2e8f0}
    .card{width:min(680px,92vw);background:#111827;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgb(0 0 0 / .35)}
    h1{font-size:clamp(1.2rem,2.5vw,1.6rem);margin:0 0 8px}
    .meta{opacity:.8;font-size:.9rem;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .tile{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:14px}
    .addr{font-family:ui-monospace,Consolas,monospace;font-size:.85rem;opacity:.9}
    .val{font-size:2.2rem;line-height:1.1}
    .ok{color:#86efac} .warn{color:#fbbf24} .bad{color:#fca5a5}
    footer{margin-top:10px;opacity:.7;font-size:.8rem}
    code{background:#111827;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="card">
    <h1>ESP32 → DS18B20 Realtime</h1>
    <div class="meta">Status: <span id="status">connecting…</span> · Interval: <span id="ivl">—</span> ms</div>
    <div id="grid" class="grid"></div>
    <footer>WebSocket <code id="wsurl"></code></footer>
  </div>
<script>

    var ws_host = "192.168.8.161";


(() => {
  const $ = (id)=>document.getElementById(id);
  const grid = $("grid");
  const statusEl = $("status");
  const ivlEl = $("ivl");
  const wsUrl = `ws://${ws_host}/ws`;
  $("wsurl").textContent = wsUrl;

  let lastTs = 0;
  const tiles = new Map();

  function ensureTile(addr){
    if(tiles.has(addr)) return tiles.get(addr);
    const d = document.createElement('div');
    d.className = 'tile';
    d.innerHTML = `<div class="addr">${addr}</div><div class="val">—</div>`;
    grid.appendChild(d);
    tiles.set(addr, d);
    return d;
  }

  function clsForTemp(c){
    if(c==null) return '';
    if(c < 0 || c > 60) return 'bad';
    if(c >= 40) return 'warn';
    return 'ok';
  }

  let ws;
  function connect(){
    ws = new WebSocket(wsUrl);
    ws.onopen = () => statusEl.textContent = 'connected';
    ws.onclose = () => { statusEl.textContent = 'disconnected'; setTimeout(connect, 1000); };
    ws.onerror = () => { statusEl.textContent = 'error'; };
    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if(msg.type === 'temps'){
          if(lastTs) ivlEl.textContent = (msg.ts - lastTs);
          lastTs = msg.ts;
          msg.sensors.forEach(s => {
            const d = ensureTile(s.addr);
            const v = d.querySelector('.val');
            const c = s.c == null ? '—' : s.c.toFixed(2) + ' °C';
            v.textContent = c;
            v.className = 'val ' + clsForTemp(s.c);
          });
        }
      } catch(e) { console.error(e); }
    };
  }

  connect();
})();
</script>
</body>
</html>
